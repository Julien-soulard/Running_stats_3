<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Stats - Progression</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app" class="w-full min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                üèÉ Progression Running
            </h1>
            <p class="text-gray-600 mb-6">Analyse de vos s√©ances</p>

            <!-- Stats Cards -->
            <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

            <!-- Tabs -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="showView('distance')" id="btn-distance" class="px-4 py-2 rounded-lg font-medium transition bg-indigo-600 text-white shadow-md">
                    Distance par s√©ance
                </button>
                <button onclick="showView('duree')" id="btn-duree" class="px-4 py-2 rounded-lg font-medium transition bg-white text-gray-700 hover:bg-gray-100">
                    Dur√©e par s√©ance
                </button>
                <button onclick="showView('pace')" id="btn-pace" class="px-4 py-2 rounded-lg font-medium transition bg-white text-gray-700 hover:bg-gray-100">
                    Allure par s√©ance
                </button>
                <button onclick="showView('weekly')" id="btn-weekly" class="px-4 py-2 rounded-lg font-medium transition bg-white text-gray-700 hover:bg-gray-100">
                    Statistiques hebdomadaires
                </button>
                <button onclick="showView('monthly')" id="btn-monthly" class="px-4 py-2 rounded-lg font-medium transition bg-white text-gray-700 hover:bg-gray-100">
                    Statistiques mensuelles
                </button>
            </div>

            <!-- Chart Container -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 id="chart-title" class="text-xl font-semibold text-gray-800 mb-4">Distance par s√©ance</h2>
                
                <!-- Checkboxes for weekly view -->
                <div id="weekly-controls" class="hidden flex gap-3 mb-4 flex-wrap">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-km" checked class="w-4 h-4 text-indigo-600 rounded" onchange="updateWeeklyChart()">
                        <span class="text-sm font-medium text-gray-700">Distance (km)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-min" checked class="w-4 h-4 text-amber-600 rounded" onchange="updateWeeklyChart()">
                        <span class="text-sm font-medium text-gray-700">Temps (min)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-pace" checked class="w-4 h-4 text-purple-600 rounded" onchange="updateWeeklyChart()">
                        <span class="text-sm font-medium text-gray-700">Allure (min/km)</span>
                    </label>
                </div>

                <!-- Checkboxes for monthly view -->
                <div id="monthly-controls" class="hidden flex gap-3 mb-4 flex-wrap">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-km-monthly" checked class="w-4 h-4 text-indigo-600 rounded" onchange="updateMonthlyChart()">
                        <span class="text-sm font-medium text-gray-700">Distance (km)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-min-monthly" checked class="w-4 h-4 text-amber-600 rounded" onchange="updateMonthlyChart()">
                        <span class="text-sm font-medium text-gray-700">Temps (min)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check-pace-monthly" checked class="w-4 h-4 text-purple-600 rounded" onchange="updateMonthlyChart()">
                        <span class="text-sm font-medium text-gray-700">Allure (min/km)</span>
                    </label>
                </div>

                <div style="position: relative; height: 400px;">
                    <canvas id="mainChart"></canvas>
                </div>
                <p id="pace-note" class="text-sm text-gray-600 mt-2 text-center hidden">
                    ‚¨áÔ∏è Plus la courbe descend, plus vous courez vite
                </p>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let weeklyStats = [];
        let monthlyStats = [];
        let currentChart = null;
        let currentView = 'distance';

        // Load CSV data
        Papa.parse('data.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data.map(row => ({
                    seance: row.seance,
                    date: new Date(row.date),
                    duree: row.duree_min,
                    distance: row.distance_km,
                    semaine: row.semaine,
                    pace: row.duree_min / row.distance_km
                }));

                // Calculate weekly stats
                const maxWeek = Math.max(...allData.map(d => d.semaine));
                for (let week = 1; week <= maxWeek; week++) {
                    const weekData = allData.filter(d => d.semaine === week);
                    if (weekData.length > 0) {
                        const totalKm = weekData.reduce((sum, d) => sum + d.distance, 0);
                        const totalMin = weekData.reduce((sum, d) => sum + d.duree, 0);
                        weeklyStats.push({
                            semaine: `S${week}`,
                            totalKm: totalKm,
                            totalMin: totalMin,
                            avgPace: totalMin / totalKm
                        });
                    }
                }

                // Calculate monthly stats
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                   'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                const monthlyData = {};
                
                allData.forEach(d => {
                    const monthKey = `${d.date.getFullYear()}-${d.date.getMonth()}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            year: d.date.getFullYear(),
                            month: d.date.getMonth(),
                            data: []
                        };
                    }
                    monthlyData[monthKey].data.push(d);
                });

                monthlyStats = Object.values(monthlyData).map(m => {
                    const totalKm = m.data.reduce((sum, d) => sum + d.distance, 0);
                    const totalMin = m.data.reduce((sum, d) => sum + d.duree, 0);
                    return {
                        label: `${monthNames[m.month]} ${m.year}`,
                        totalKm: totalKm,
                        totalMin: totalMin,
                        avgPace: totalMin / totalKm
                    };
                });

                displayStats();
                showView('distance');
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
                document.getElementById('app').innerHTML = '<div class="text-center text-red-600 text-2xl mt-20">Erreur lors du chargement des donn√©es</div>';
            }
        });

        function displayStats() {
            const totalDistance = allData.reduce((sum, d) => sum + d.distance, 0);
            const totalDuration = allData.reduce((sum, d) => sum + d.duree, 0);
            const avgPace = totalDuration / totalDistance;

            document.getElementById('stats-cards').innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Distance totale</p>
                            <p class="text-3xl font-bold text-indigo-600">${totalDistance.toFixed(1)} km</p>
                        </div>
                        <span class="text-4xl">üìà</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Temps total</p>
                            <p class="text-3xl font-bold text-green-600">${Math.floor(totalDuration / 60)}h ${Math.floor(totalDuration % 60)}min</p>
                        </div>
                        <span class="text-4xl">‚è±Ô∏è</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Allure moyenne</p>
                            <p class="text-3xl font-bold text-purple-600">${Math.floor(avgPace)}:${Math.floor((avgPace % 1) * 60).toString().padStart(2, '0')}/km</p>
                        </div>
                        <span class="text-4xl">‚ö°</span>
                    </div>
                </div>
            `;
        }

        function showView(view) {
            currentView = view;
            
            // Update buttons
            ['distance', 'duree', 'pace', 'weekly', 'monthly'].forEach(v => {
                const btn = document.getElementById(`btn-${v}`);
                if (v === view) {
                    btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-indigo-600 text-white shadow-md';
                } else {
                    btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-white text-gray-700 hover:bg-gray-100';
                }
            });

            // Update title and controls
            const titles = {
                distance: 'Distance par s√©ance',
                duree: 'Dur√©e par s√©ance',
                pace: 'Allure par s√©ance',
                weekly: 'Statistiques hebdomadaires',
                monthly: 'Statistiques mensuelles'
            };
            document.getElementById('chart-title').textContent = titles[view];
            document.getElementById('weekly-controls').classList.toggle('hidden', view !== 'weekly');
            document.getElementById('monthly-controls').classList.toggle('hidden', view !== 'monthly');
            document.getElementById('pace-note').classList.toggle('hidden', view !== 'pace');

            // Update chart
            if (view === 'weekly') {
                updateWeeklyChart();
            } else if (view === 'monthly') {
                updateMonthlyChart();
            } else if (view === 'distance') {
                createLineChart('distance', 'Distance (km)', '#4f46e5');
            } else if (view === 'duree') {
                createBarChart('duree', 'Dur√©e (min)', '#10b981');
            } else if (view === 'pace') {
                createLineChart('pace', 'Allure (min/km)', '#a855f7', true);
            }
        }

        function createLineChart(dataKey, label, color, reversed = false) {
            if (currentChart) currentChart.destroy();

            const ctx = document.getElementById('mainChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allData.map(d => d.seance),
                    datasets: [{
                        label: label,
                        data: allData.map(d => d[dataKey]),
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 3,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: reversed,
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (dataKey === 'pace') {
                                        const mins = Math.floor(context.parsed.y);
                                        const secs = Math.floor((context.parsed.y - mins) * 60);
                                        return `${label}: ${mins}:${secs.toString().padStart(2, '0')}/km`;
                                    }
                                    return `${label}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(dataKey, label, color) {
            if (currentChart) currentChart.destroy();

            const ctx = document.getElementById('mainChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allData.map(d => d.seance),
                    datasets: [{
                        label: label,
                        data: allData.map(d => d[dataKey]),
                        backgroundColor: color,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateWeeklyChart() {
            if (currentChart) currentChart.destroy();

            const showKm = document.getElementById('check-km').checked;
            const showMin = document.getElementById('check-min').checked;
            const showPace = document.getElementById('check-pace').checked;

            const datasets = [];
            
            if (showKm) {
                datasets.push({
                    label: 'Distance totale (km)',
                    data: weeklyStats.map(w => w.totalKm),
                    backgroundColor: '#4f46e5',
                    borderRadius: 8
                });
            }
            
            if (showMin) {
                datasets.push({
                    label: 'Temps total (min)',
                    data: weeklyStats.map(w => w.totalMin),
                    backgroundColor: '#f59e0b',
                    borderRadius: 8
                });
            }
            
            if (showPace) {
                datasets.push({
                    label: 'Allure moyenne (min/km)',
                    data: weeklyStats.map(w => w.avgPace),
                    backgroundColor: '#a855f7',
                    borderRadius: 8
                });
            }

            const ctx = document.getElementById('mainChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyStats.map(w => w.semaine),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('Allure')) {
                                        const mins = Math.floor(context.parsed.y);
                                        const secs = Math.floor((context.parsed.y - mins) * 60);
                                        return `${context.dataset.label}: ${mins}:${secs.toString().padStart(2, '0')}/km`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>